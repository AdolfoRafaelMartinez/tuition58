<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kalshi Trade Bot</title>
    <link rel="stylesheet" href="/styles.css">
</head>
<body>
    <div class="container" data-balance="<%= kalshi ? kalshi.balance : 0 %>">
        <h1>Tuition Bot</h1>
        <div id="location-container">
            <label for="location-select">Location:</label>
            <select id="location-select" aria-label="Select forecast location">
                <option value="bergstrom">Bergstrom (Austin)</option>
                <option value="centralpark">Central Park (NYC)</option>
                <option value="seattle">Seattle</option>
            </select>
        </div>
        
        <!-- Current temperature moved into Forecast card -->
        <div class="section">
            <h2>Weather</h2>
            <div id="forecast-display">
                <div id="current-display">
                    <% if (current && current.temperature) { %>
                        <p><strong>Current:</strong> <span id="current-temp"><%= (current.temperature * 9/5 + 32).toFixed(2) %></span>°F</p>
                        <div id="generated-time">Observed at: <%= generatedAt.toLocaleString() %></div>
                    <% } else { %>
                        <p id="current-unavailable">Current temperature not available.</p>
                    <% } %>
                </div>
                <% if (weather) { %>
                    <p><strong id="forecast-name"><%= weather.name %>'s High</strong>: <span id="forecast-temp"><%= weather.temperature %></span>°<span id="forecast-unit"><%= weather.temperatureUnit %></span></p>
                    <p>Generated at <span id="forecast-date"><%= new Date(weather.startTime).toLocaleString() %></span></p>
                <% } else { %>
                    <p id="forecast-unavailable">Weather data not available.</p>
                <% } %>
            </div>
        </div>
        <div class="section">
            <h2>Kalshi</h2>
            <% if (kalshi) { %>
                <p><strong>Balance:</strong> $<%= (kalshi.balance / 100).toFixed(2) %></p>
            <% } else { %>
                <p>Kalshi data not available.</p>
            <% } %>
        </div>
        <div class="section">
            <h2>Get Open Markets</h2>
            <form id="market-form">
                <label for="event-ticker">Event Ticker:</label>
                <input type="text" id="event-ticker" name="event-ticker" value="KXHIGHAUS-26JAN26" required>
                <button type="submit">Get Markets</button>
            </form>
            <div id="market-result"></div>
        </div>
        <div class="section">
            <h2>Place Orders</h2>
            <div id="order-forms-container"></div>
            <button id="place-all-orders" style="display:none;">Place All Orders</button>
            <div id="order-result"></div>
        </div>
        <div class="section">
            <h2>Positions</h2>
            <div id="positions-result"></div>
        </div>
        <div class="section">
            <h2>Trades</h2>
            <div id="trades-result"></div>
        </div>
    </div>
    <script src="/js/weatherSelector.js"></script>
    <script src="/js/orderForm.js"></script>
    <script src="/js/marketForm.js"></script>
    <script src="/js/trades.js"></script>
    <script>
        function generateAndDisplayTicker() {
            <% if (weather && weather.startTime) { %>
                const forecastDate = new Date('<%= weather.startTime %>');
                const year = forecastDate.getFullYear().toString().slice(-2);
                const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                const month = months[forecastDate.getMonth()];
                const day = String(forecastDate.getDate()).padStart(2, '0');
                const dateString = `${year}${month}${day}`;
                const ticker = `KXHIGHAUS-${dateString}`;
                const eventTickerInput = document.getElementById('event-ticker');
                if (eventTickerInput) {
                    eventTickerInput.value = ticker;
                }
            <% } else { %>
                const now = new Date();
                const year = now.getFullYear().toString().slice(-2);
                const months = ["JAN", "FEB", "MAR", "APR", "MAY", "JUN", "JUL", "AUG", "SEP", "OCT", "NOV", "DEC"];
                const month = months[now.getMonth()];
                const day = String(now.getDate()).padStart(2, '0');
                const dateString = `${year}${month}${day}`;
                const ticker = `KXHIGHAUS-${dateString}`;
                const eventTickerInput = document.getElementById('event-ticker');
                if (eventTickerInput) {
                    eventTickerInput.value = ticker;
                }
            <% } %>
            // Fetch markets after ticker is generated
            if (window.fetchAndDisplayMarkets) {
                window.fetchAndDisplayMarkets();
            }
        }
        document.addEventListener('DOMContentLoaded', generateAndDisplayTicker);
    </script>
</body>
</html>